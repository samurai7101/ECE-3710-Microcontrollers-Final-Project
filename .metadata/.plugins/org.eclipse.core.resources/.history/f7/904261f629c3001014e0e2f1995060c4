/*
 * pong.c (STM32 + SSD1306 I2C Version)
 * Author: Austin Herbst
 * Date: Oct 29, 2025
 */

#include "main.h"
#include "ssd1306.h"
#include "ssd1306_fonts.h"
#include "stm32l476xx.h"
#include <stdbool.h>
#include <stdlib.h>
#include <stdio.h>
#include "pong.h"

// Game parameters
#define PADDLE_HEIGHT 12
#define BALL_RATE 16
#define PADDLE_RATE 64
#define SCORE_LIMIT 9

// Game state variables
bool game_over = false, win = false;
uint8_t player_score = 0, mcu_score = 0;

uint8_t ball_x = 53, ball_y = 26;
int8_t ball_dir_x = 1, ball_dir_y = 1;

uint32_t last_ball_update = 0;
uint32_t last_paddle_update = 0;

const uint8_t MCU_X = 12;
uint8_t mcu_y = 16;

const uint8_t PLAYER_X = 115;
uint8_t player_y = 16;

/* Delay in ms using HAL */
void delay_ms(uint32_t ms) {
    HAL_Delay(ms);
}

/* Button read helper */
bool read_button(GPIO_TypeDef* port, uint16_t pin) {
    return HAL_GPIO_ReadPin(port, pin) == GPIO_PIN_RESET;
}

/* Buzzer tone functions */
void tone(uint16_t frequency, uint16_t duration) {
    // For simple buzzer without PWM, we'll create a basic beep
    // If you have PWM configured, you can use HAL_TIM_PWM_Start instead
    for(uint16_t i = 0; i < duration; i++) {
        HAL_GPIO_WritePin(BUZZER_GPIO_Port, BUZZER_Pin, GPIO_PIN_SET);
        delay_ms(1);
        HAL_GPIO_WritePin(BUZZER_GPIO_Port, BUZZER_Pin, GPIO_PIN_RESET);
        delay_ms(1);
    }
}

void noTone(void) {
    HAL_GPIO_WritePin(BUZZER_GPIO_Port, BUZZER_Pin, GPIO_PIN_RESET);
}

void playerPaddleTone(void) {
    tone(250, 25);
    delay_ms(25);
    noTone();
}

void mcuPaddleTone(void) {
    tone(225, 25);
    delay_ms(25);
    noTone();
}

void wallTone(void) {
    tone(200, 25);
    delay_ms(25);
    noTone();
}

void player_scoreTone(void) {
    tone(200, 25);
    delay_ms(50);
    noTone();
    delay_ms(25);
    tone(250, 25);
    delay_ms(25);
    noTone();
}

void mcu_scoreTone(void) {
    tone(250, 25);
    delay_ms(25);
    noTone();
    delay_ms(25);
    tone(200, 25);
    delay_ms(25);
    noTone();
}

/* Draw game border */
void drawCourt(void) {
    ssd1306_DrawRectangle(0, 0, 127, 54, White);
}

/* Draw everything */
void drawGame(void) {
    ssd1306_Clear();

    // Draw border
    drawCourt();

    // Draw ball
    ssd1306_DrawPixel(ball_x, ball_y, White);

    // Draw paddles
    for (uint8_t i = 0; i < PADDLE_HEIGHT; i++) {
        ssd1306_DrawPixel(MCU_X, mcu_y + i, White);
        ssd1306_DrawPixel(PLAYER_X, player_y + i, White);
    }

    // Draw scores
    ssd1306_SetCursor(0, 56);
    char buf[4];
    sprintf(buf, "%d", mcu_score);
    ssd1306_WriteString(buf, Font_7x10, White);

    ssd1306_SetCursor(122, 56);
    sprintf(buf, "%d", player_score);
    ssd1306_WriteString(buf, Font_7x10, White);

    ssd1306_UpdateScreen();
}

/* Reset game state */
void resetGame(void) {
    ball_x = 53;
    ball_y = 26;
    ball_dir_x = 1;
    ball_dir_y = 1;
    mcu_y = 16;
    player_y = 16;
    mcu_score = 0;
    player_score = 0;
    game_over = false;
}

/* One step of the game loop */
void pong_loop(void) {
    uint32_t now = HAL_GetTick();
    bool update_needed = false;

    // ---- Ball logic ----
    if (now - last_ball_update > BALL_RATE) {
        uint8_t new_x = ball_x + ball_dir_x;
        uint8_t new_y = ball_y + ball_dir_y;

        // Vertical walls
        if (new_x == 0 || new_x == 127) {
            ball_dir_x = -ball_dir_x;
            new_x += ball_dir_x + ball_dir_x;

            if (new_x < 64) {
                player_scoreTone();
                player_score++;
            } else {
                mcu_scoreTone();
                mcu_score++;
            }

            if (player_score == SCORE_LIMIT || mcu_score == SCORE_LIMIT) {
                win = (player_score > mcu_score);
                game_over = true;
            }
        }

        // Horizontal walls
        if (new_y == 0 || new_y == 53) {
            wallTone();
            ball_dir_y = -ball_dir_y;
            new_y += ball_dir_y + ball_dir_y;
        }

        // CPU paddle collision
        if (new_x == MCU_X && new_y >= mcu_y && new_y <= mcu_y + PADDLE_HEIGHT) {
            mcuPaddleTone();
            ball_dir_x = -ball_dir_x;
            new_x += ball_dir_x + ball_dir_x;
        }

        // Player paddle collision
        if (new_x == PLAYER_X && new_y >= player_y && new_y <= player_y + PADDLE_HEIGHT) {
            playerPaddleTone();
            ball_dir_x = -ball_dir_x;
            new_x += ball_dir_x + ball_dir_x;
        }

        ball_x = new_x;
        ball_y = new_y;

        last_ball_update = now;
        update_needed = true;
    }

    // ---- Paddle logic ----
    if (now - last_paddle_update > PADDLE_RATE) {
        last_paddle_update = now;

        // Simple AI for MCU paddle
        uint8_t half = PADDLE_HEIGHT / 2;
        if (mcu_y + half > ball_y) mcu_y--;
        else if (mcu_y + half < ball_y) mcu_y++;

        if (mcu_y < 1) mcu_y = 1;
        if (mcu_y + PADDLE_HEIGHT > 53) mcu_y = 53 - PADDLE_HEIGHT;

        // Player control
        if (read_button(UP_BUTTON_GPIO_Port, UP_BUTTON_Pin)) player_y--;
        if (read_button(DOWN_BUTTON_GPIO_Port, DOWN_BUTTON_Pin)) player_y++;

        if (player_y < 1) player_y = 1;
        if (player_y + PADDLE_HEIGHT > 53) player_y = 53 - PADDLE_HEIGHT;

        update_needed = true;
    }

    // ---- Game over screen ----
    if (update_needed) {
        if (game_over) {
            ssd1306_Clear();
            ssd1306_SetCursor(30, 28);
            ssd1306_WriteString(win ? "YOU WIN!" : "YOU LOSE!", Font_7x10, White);
            ssd1306_UpdateScreen();

            // Play victory/failure sound
            if (win) {
                player_scoreTone(); // Reuse the scoring sound for victory
            } else {
                mcu_scoreTone(); // Reuse the scoring sound for loss
            }

            HAL_Delay(3000);
            resetGame();
        }
        drawGame();
    }
}

/* Call this once at startup */
void pong_setup(void) {
    // Initialize buzzer pin
    HAL_GPIO_WritePin(BUZZER_GPIO_Port, BUZZER_Pin, GPIO_PIN_RESET);

    ssd1306_Clear();
    drawCourt();
    ssd1306_SetCursor(10, 24);
    ssd1306_WriteString("PONG START", Font_7x10, White);
    ssd1306_UpdateScreen();

    // Play startup sound
    tone(300, 100);
    delay_ms(100);
    noTone();

    HAL_Delay(1500);
    resetGame();
}
