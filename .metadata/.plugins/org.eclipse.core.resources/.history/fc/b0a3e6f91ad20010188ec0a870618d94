/* pong.c */
#include "main.h"
#include "ssd1306.h"
#include "ssd1306_fonts.h"
#include "stm32l476xx.h"
#include <stdbool.h>
#include <stdio.h>
#include "pong.h"
#include "nunchuck.h"

// Board parameters
#define BOARD_SIZE_X 127
#define BOARD_SIZE_Y 51

// Nunchuck Analog Thresholds
#define JOY_UP_THRESH 200
#define JOY_DOWN_THRESH 50

// Game state
bool game_over = false, win = false;
uint8_t player_score = 0, mcu_score = 0;
uint8_t ball_x = 53, ball_y = 26;
int8_t ball_dir_x = 1, ball_dir_y = 1;
uint32_t last_ball_update = 0;
uint32_t last_paddle_update = 0;
const uint8_t MCU_X = 12;
uint8_t mcu_y = 16;
const uint8_t PLAYER_X = 115;
uint8_t player_y = 16;

void delay_ms(uint32_t ms) { HAL_Delay(ms); }
void buzzpulse();
void buzzer(uint16_t freq){
	buzzpulse();
	for(int i = 0; i < freq; i++){}
}
void buzzpulse(){
        HAL_GPIO_WritePin(BUZZER_GPIO_Port, BUZZER_Pin, GPIO_PIN_SET);
        delay_ms(1);
        HAL_GPIO_WritePin(BUZZER_GPIO_Port, BUZZER_Pin, GPIO_PIN_RESET);
        delay_ms(1);
}


// --- Tone Functions (Same as before) ---
void tone(uint16_t frequency, uint16_t duration) {
    for(uint16_t i = 0; i < duration; i++) {
        buzzer(frequency);
    }
}

void noTone(void) { HAL_GPIO_WritePin(BUZZER_GPIO_Port, BUZZER_Pin, GPIO_PIN_RESET); }
void playerPaddleTone(void) { tone(250, 25); delay_ms(25); noTone(); }
void mcuPaddleTone(void) { tone(225, 25); delay_ms(25); noTone(); }
void wallTone(void) { tone(200, 25); delay_ms(25); noTone(); }
void player_scoreTone(void) { tone(200, 25); delay_ms(50); noTone(); delay_ms(25); tone(250, 25); delay_ms(25); noTone(); }
void mcu_scoreTone(void) { tone(250, 25); delay_ms(25); noTone(); delay_ms(25); tone(200, 25); delay_ms(25); noTone(); }

void drawCourt(void) { ssd1306_DrawRectangle(0, 0, BOARD_SIZE_X, BOARD_SIZE_Y, White); }

void drawGame(void) {
    ssd1306_Clear();
    drawCourt();
    ssd1306_DrawPixel(ball_x, ball_y, White);

    for (uint8_t i = 0; i < PADDLE_HEIGHT; i++) {
        ssd1306_DrawPixel(MCU_X, mcu_y + i, White);
        ssd1306_DrawPixel(PLAYER_X, player_y + i, White);
    }

    char buf[4];
    ssd1306_SetCursor(0, 53);
    sprintf(buf, "%d", mcu_score);
    ssd1306_WriteString(buf, Font_7x10, White);

    ssd1306_SetCursor(BOARD_SIZE_X - 6, BOARD_SIZE_Y + 2); //122, 56
    sprintf(buf, "%d", player_score);
    ssd1306_WriteString(buf, Font_7x10, White);

    ssd1306_UpdateScreen();
}

void resetGame(void) {
    ball_x = 53; ball_y = 26; ball_dir_x = 1; ball_dir_y = 1;
    mcu_y = 16; player_y = 16; mcu_score = 0; player_score = 0;
    game_over = false;
}

void pong_loop(void) {
    uint32_t now = HAL_GetTick();
    bool update_needed = false;

    // Ball Logic
    if (now - last_ball_update > BALL_RATE) {
        uint8_t new_x = ball_x + ball_dir_x;
        uint8_t new_y = ball_y + ball_dir_y;

        if (new_x == 0 || new_x == BOARD_SIZE_X - 1) {
            ball_dir_x = -ball_dir_x;
            new_x += ball_dir_x + ball_dir_x;
            if (new_x < 64) { player_scoreTone(); player_score++; }
            else { mcu_scoreTone(); mcu_score++; }
            if (player_score == SCORE_LIMIT || mcu_score == SCORE_LIMIT) {
                win = (player_score > mcu_score);
                game_over = true;
            }
        }

        if (new_y == 0 || new_y == BOARD_SIZE_Y - 1) {
            wallTone();
            ball_dir_y = -ball_dir_y;
            new_y += ball_dir_y + ball_dir_y;
        }

        if (new_x == MCU_X && new_y >= mcu_y && new_y <= mcu_y + PADDLE_HEIGHT) {
            mcuPaddleTone();
            ball_dir_x = -ball_dir_x;
            new_x += ball_dir_x + ball_dir_x;
        }

        if (new_x == PLAYER_X && new_y >= player_y && new_y <= player_y + PADDLE_HEIGHT) {
            playerPaddleTone();
            ball_dir_x = -ball_dir_x;
            new_x += ball_dir_x + ball_dir_x;
        }

        ball_x = new_x;
        ball_y = new_y;
        last_ball_update = now;
        update_needed = true;
    }

    // Paddle Logic (NUNCHUCK)
    if (now - last_paddle_update > PADDLE_RATE) {
        last_paddle_update = now;

        nunchuck_t chuck = nunchuck_read();

        // Restart Game Check (C Button)
        if (game_over && chuck.c_btn) {
            resetGame();
            HAL_Delay(500);
        }

        // Player Paddle Control (Joystick Y)
        if (!game_over) {
            if (chuck.joy_y > JOY_UP_THRESH) player_y--;
            if (chuck.joy_y < JOY_DOWN_THRESH) player_y++;

            if (player_y < 1) player_y = 1;
            if (player_y + PADDLE_HEIGHT > BOARD_SIZE_Y - 1) player_y = BOARD_SIZE_Y - 1 - PADDLE_HEIGHT;
        }

        // MCU AI
        uint8_t half = PADDLE_HEIGHT / 2;
        if (mcu_y + half > ball_y) mcu_y--;
        else if (mcu_y + half < ball_y) mcu_y++;
        if (mcu_y < 1) mcu_y = 1;
        if (mcu_y + PADDLE_HEIGHT > BOARD_SIZE_Y - 1) mcu_y = BOARD_SIZE_Y - 1 - PADDLE_HEIGHT;

        update_needed = true;
    }

    if (update_needed) {
        if (game_over) {
            ssd1306_Clear();
            ssd1306_SetCursor(30, 28);
            ssd1306_WriteString(win ? "YOU WIN!" : "YOU LOSE!", Font_7x10, White);
            ssd1306_SetCursor(10, 45);
            ssd1306_WriteString("Press C to Restart", Font_6x8, White);
            ssd1306_UpdateScreen();
        } else {
            drawGame();
        }
    }
}

void pong_setup(void) {
    HAL_GPIO_WritePin(BUZZER_GPIO_Port, BUZZER_Pin, GPIO_PIN_RESET);

    // Initialize the Nunchuck (sends 0x40, 0x00)
    nunchuck_init();

    ssd1306_Clear();
    drawCourt();
    ssd1306_SetCursor(10, 24);
    ssd1306_WriteString("PONG START", Font_7x10, White);
    ssd1306_UpdateScreen();

    tone(1000, 100);
    delay_ms(100);
    noTone();

    HAL_Delay(1500);
    resetGame();
}
